<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Client Login</title>
		<link rel="stylesheet" href="/global.css" />
		<script type="module">
			import { GetWebCode, CallRESTAPI, createCookie } from "/utils.js";

			document.addEventListener("DOMContentLoaded", function () {
				const loginForm = document.getElementById("login-form");
				const errorMessageDiv = document.getElementById("errormessage");

				loginForm.addEventListener("submit", async function (event) {
					event.preventDefault(); // Prevent the default form submission

					// Clear previous error message
					errorMessageDiv.textContent = "";

					// Get form values
					const username = document.getElementById("username").value;
					const email = document.getElementById("email").value;
					const password = document.getElementById("password").value;

					const webcode = await GetWebCode(`${username}:${email}:${password}`);

					// Prepare data to send
					const requestData = {
						AccountName: username,
						WebCode: webcode,
					};

					try {
						// Call the REST API (use absolute path)
						const result = await CallRESTAPI(
							"/webClientLoginAllowed",
							"POST",
							{ body: requestData },
						);

						// On successful login, create cookies and redirect
						createCookie("AccountName", username, 1, { sameSite: "Lax" });
						createCookie("WebCode", webcode, 1, { sameSite: "Lax" });
						window.location.href = "/clientinfo.html";
					} catch (err) {
						// Try to show server-provided message
						if (err && err.body) {
							try {
								const parsed = JSON.parse(err.body);
								errorMessageDiv.textContent = parsed.message || parsed.error || "Login failed.";
							} catch (e) {
								errorMessageDiv.textContent = err.body || "Login failed.";
							}
						} else {
							errorMessageDiv.textContent = "An error occurred. Please try again later.";
						}
						console.log(err);
					}
				});
			});
		</script>
	</head>
	<body>
		<div id="login-container" class="container">
			<h1>Data Generator</h1>
			<h2>Client Login</h2>
			<form id="login-form" action="/clientlogin" method="post">
				<label for="username">Account name:</label>
				<input type="text" id="username" name="username" required />
				<label for="email">Account email:</label>
				<input type="email" id="email" name="email" required />
				<label for="password">Password:</label>
				<input type="password" id="password" name="password" required />
				<input type="submit" value="Login" />
				<div id="errormessage"></div>
			</form>
		</div>
	</body>
</html>
